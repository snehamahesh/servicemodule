<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PulsarProcessor.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">service-module</a> &gt; <a href="index.source.html" class="el_package">com.feed.zia.impl</a> &gt; <span class="el_source">PulsarProcessor.java</span></div><h1>PulsarProcessor.java</h1><pre class="source lang-java linenums">package com.feed.zia.impl;

import com.feed.zia.PulseProcessorIfc;
import com.feed.zia.PulseServiceIfc;
import com.feed.zia.conf.PConfig;
import com.feed.zia.conf.Services;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.yaml.snakeyaml.Yaml;

import java.io.IOException;
import java.io.InputStream;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.List;
import java.util.Optional;
import java.util.concurrent.Callable;
import java.util.concurrent.CompletionService;
import java.util.concurrent.ExecutorCompletionService;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.Future;

// TBD: Find the cycles in the dependencyGraph and abort as there is no easy way out yet!!!

public class PulsarProcessor implements PulseProcessorIfc {
<span class="fc" id="L27">    private static final Logger LOG = LoggerFactory.getLogger(PulsarProcessor.class);</span>

//    private final ExecutorService executorService;
    private final CompletionService&lt;PulseServiceIfc&gt; completionService;
    private final Optional&lt;Services&gt; config;

    protected PulsarProcessor(String configFile)
<span class="fc" id="L34">            throws IOException {</span>
<span class="pc" id="L35">        try (InputStream in = Files.newInputStream(Paths.get(configFile))) {</span>
<span class="fc" id="L36">            config = Optional.ofNullable(new Yaml().loadAs(in, Services.class));</span>
<span class="pc bpc" id="L37" title="6 of 8 branches missed.">        }</span>
<span class="fc" id="L38">        Services services = config.orElse(new Services());</span>
<span class="fc" id="L39">        List&lt;PConfig&gt; configs = services.getServices();</span>
<span class="fc bfc" id="L40" title="All 2 branches covered.">        for (PConfig pulsar : configs) {</span>
//                System.out.println(pulsar);
<span class="fc bfc" id="L42" title="All 2 branches covered.">            if (pulsar.getDependencies() != null) {</span>
<span class="fc" id="L43">                pulsar.getDependencies().forEach(name -&gt; {</span>
<span class="fc" id="L44">                    configs.stream().filter(s -&gt; name.equals(s.getName()))</span>
<span class="fc" id="L45">                            .forEach(p -&gt; {</span>
<span class="fc" id="L46">                                services.addDependent(pulsar, p);</span>
<span class="fc" id="L47">                                pulsar.incrementOutDegree();</span>
<span class="fc" id="L48">                            });</span>
<span class="fc" id="L49">                });</span>
            } else {
<span class="fc" id="L51">                services.addEmptyDependent(pulsar);</span>
            }
<span class="fc" id="L53">        }</span>
<span class="fc" id="L54">        System.out.println(&quot;Service Dependency Graph: \n&quot; + services);</span>
<span class="fc" id="L55">        ExecutorService executorService = Executors.newFixedThreadPool(configs.size());</span>
<span class="fc" id="L56">        completionService = new ExecutorCompletionService&lt;PulseServiceIfc&gt;(executorService);</span>
<span class="fc" id="L57">    }</span>

    Services getConfig() {
<span class="fc" id="L60">        return config.orElse(new Services());</span>
    }

    private Future&lt;PulseServiceIfc&gt; submit(Services services, PConfig pConfig) {
<span class="fc" id="L64">        System.out.println(&quot;LAUNCHING: &quot; + pConfig);</span>
<span class="fc" id="L65">        pConfig.setService(new PulseService(pConfig,</span>
<span class="fc" id="L66">                services.getDependsOn(pConfig),</span>
<span class="fc" id="L67">                services.getDependentsOf(pConfig)));</span>
<span class="fc" id="L68">        return completionService.submit(new Callable&lt;PulseServiceIfc&gt;() {</span>
            public PulseServiceIfc call() {
<span class="fc" id="L70">                Thread thread = Thread.currentThread();</span>
<span class="fc" id="L71">                thread.setName(&quot;service-&quot; + String.format(&quot;%s&quot;, pConfig.toString()));</span>
<span class="fc" id="L72">                pConfig.getService().start();</span>
<span class="fc" id="L73">                return pConfig.getService();</span>
            }
        });
    }

    public void start(PConfig serviceConfig) {
<span class="fc" id="L79">        Services services = config.orElse(new Services());</span>
<span class="fc bfc" id="L80" title="All 2 branches covered.">        if (serviceConfig.getService() == null) {</span>
<span class="fc" id="L81">            submit(services, serviceConfig);</span>
        }
<span class="fc" id="L83">        List&lt;PConfig&gt; dependsOn = services.getDependsOn(serviceConfig);</span>
<span class="fc" id="L84">        dependsOn.forEach(pConfig -&gt; {</span>
<span class="fc bfc" id="L85" title="All 2 branches covered.">            if (pConfig.getService() == null) {</span>
<span class="fc" id="L86">                start(pConfig);</span>
            }
<span class="fc" id="L88">        });</span>
<span class="fc" id="L89">    }</span>

    public void startAll() {
<span class="fc" id="L92">        Thread thread = Thread.currentThread();</span>
<span class="fc" id="L93">        thread.setName(&quot;PULSE_SERVER-&quot; + String.format(&quot;%03d&quot;, thread.getId()));</span>
<span class="fc" id="L94">        Services services = config.orElse(new Services());</span>
<span class="fc" id="L95">        List&lt;PConfig&gt; configs = services.getServices();</span>

<span class="fc bfc" id="L97" title="All 2 branches covered.">        for (PConfig serviceConfig : configs) {</span>
<span class="fc" id="L98">            start(serviceConfig);</span>
<span class="fc" id="L99">        }</span>
<span class="fc" id="L100">    }</span>

    public void stop(PConfig serviceConfig) {
<span class="pc bpc" id="L103" title="1 of 4 branches missed.">        if (serviceConfig.getService() != null &amp;&amp; !serviceConfig.getService().atExit()) {</span>
<span class="fc" id="L104">            System.out.println(&quot;STOPPING: &quot; + serviceConfig);</span>
<span class="fc" id="L105">            serviceConfig.getService().stop();</span>
        }
<span class="fc" id="L107">        Services services = config.orElse(new Services());</span>
<span class="fc" id="L108">        List&lt;PConfig&gt; dependentsOf = services.getDependentsOf(serviceConfig);</span>
<span class="fc" id="L109">        dependentsOf.forEach(pConfig -&gt; {</span>
<span class="fc bfc" id="L110" title="All 2 branches covered.">            if (pConfig.getService() != null) {</span>
<span class="fc" id="L111">                stop(pConfig);</span>
            }
<span class="fc" id="L113">        });</span>
<span class="fc" id="L114">    }</span>

    public void stopAll() {
<span class="fc" id="L117">        Services services = config.orElse(new Services());</span>
<span class="fc" id="L118">        List&lt;PConfig&gt; configs = services.getServices();</span>
<span class="fc bfc" id="L119" title="All 2 branches covered.">        for (PConfig serviceConfig : configs) {</span>
<span class="fc" id="L120">            stop(serviceConfig);</span>
<span class="fc" id="L121">        }</span>
//        shutdownAndAwaitTermination();
<span class="fc" id="L123">    }</span>

    // TBD: shutdown the executorService properly to cleanup the services hosted!!!  Later, later, later!

    //CHECKSTYLE IGNORE MagicNumber FOR NEXT 25 LINE
//    private void shutdownAndAwaitTermination() {
//        executorService.shutdown(); // Disable new tasks from being submitted
//        try {
//            // Wait a while for existing tasks to terminate
//            if (!executorService.awaitTermination(60, TimeUnit.SECONDS)) {
//                executorService.shutdownNow(); // Cancel currently executing tasks
//                // Wait a while for tasks to respond to being cancelled
//                if (!executorService.awaitTermination(60, TimeUnit.SECONDS)) {
//                    System.err.println(&quot;Pool did not terminate&quot;);
//                }
//            }
//        } catch (InterruptedException ie) {
//            // (Re-)Cancel if current thread also interrupted
//            executorService.shutdownNow();
//            // Preserve interrupt status
//            Thread.currentThread().interrupt();
//        }
//    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span></div></body></html>